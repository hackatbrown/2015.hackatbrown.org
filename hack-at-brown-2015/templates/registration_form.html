<div class='panel double_right'>
    <form action='{{ registration_post_url }}' id='registration_form' class='registration_form ui form' method='POST' enctype="multipart/form-data">

        <div class="two fields row">
            <div class="field">
                <label for="name">Name</label>
                <input type="text" name="name" placeholder="Josiah Carberry" required/>
            </div>
            <div class="field">
                <label for="name">Email</label>
                <input type="email" name="email" placeholder="handle@schooldomain.edu" required/>
            </div>
        </div>

        <div class="two fields row">
            <div class="field">
                <div class="two fields">
                    <div class="ten wide field ui-widget">
                        <label for="school">School</label>
                        <input type="text" name="school" class="schools" placeholder="Beige University" required/>
                    </div>
                    <div class="six wide field yr">
                        <label for="year">Year</label>
                        <select name="year" id="source" required />
                            <option selected="selected" value="freshman">Freshman</option>
                            <option value="sophomore">Sophomore</option>
                            <option value="junior">Junior</option>
                            <option value="senior">Senior</option>
                            <option value="highschool">High School</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="field">
                <label>T-Shirt Size</label>
                <div class="shirt_size">
                    <table class="radio_select center">
                        <tr>
                            <td>
                                <input type="radio" name="shirt_gen" id="sgM" value='M' required />
                                <label for="sgM">Men's</label>
                            </td>
                            <td>
                                <input type="radio" name="shirt_gen" id="sgW" value='W' />
                                <label for="sgW">Women's</label>
                            </td>
                        </tr>
                    </table>

                    <table class="radio_select center">
                        <tr>
                            <td>
                                <input type="radio" name="shirt_size" id="ssXS" value='XS' required />
                                <label for="ssXS">XS</label>
                            </td>
                            <td>
                                <input type="radio" name="shirt_size" id="ssS" value='S' />
                                <label for="ssS">S</label>
                            </td>
                            <td>
                                <input type="radio" name="shirt_size" id="ssM" value='M' />
                                <label for="ssM">M</label>
                            </td>
                            <td>
                                <input type="radio" name="shirt_size" id="ssL" value='L' />
                                <label for="ssL">L</label>
                            </td>
                            <td>
                                <input type="radio" name="shirt_size" id="ssXL" value='XL' />
                                <label for="ssXL">XL</label>
                            </td>
                            <td>
                                <input type="radio" name="shirt_size" id="ssXXL" value='XXL' />
                                <label for="ssXXL">XXL</label>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="field row">
            <label for="dietary_restrictions">Dietary restrictions?</label>
            <input name="dietary_restrictions" class="tagit diet" />
        </div>

        <div class="field row">
            <label for="teammates">Any Friends You'd Like to Work With? (Optional, Limit 3 Emails)</label>
            <input name="teammates" class="tagit team" />
        </div>

        <div class="two fields row">
            <div class="field">
                <label for="hardware_hack">Hardware Hack?</label>
                <table class="radio_select">
                    <tr>
                        <td>
                            <input type="radio" name="hardware_hack" id="hardware_yes" value='yes' required />
                            <label for="hardware_yes">Yes!</label>
                        </td>
                        <td>
                            <input type="radio" name="hardware_hack" id="hardware_no" value='no' />
                            <label for="hardware_no">Nah</label>
                        </td>
                    </tr>
                </table>
            </div>

            <div class="field">
                <label for="resume">Upload Resume</label>
                <input id="resume" class="resume-upload" type="file" name="resume">
                <!--                <input type="file" name="resume" id="resume" />-->
            </div>
        </div>

        <div class="two fields row">
            <div class="field">
                <label for="links">Link(s) (optional)</label>
                <div class="condor"></div>
                <!--                <input type="text" name="links" id="link" placeholder="Github, Dribbble, Behance, etc." />-->
            </div>
        </div>

        <div class="inline field center row">
            <input type="checkbox" name="agree" id="agree" required/>
            <label for="agree" class="check_agree">I agree to the Code of Conduct</label>
        </div>
        <div class="field center">
            <input type="submit" class="ui button" value="REGISTER" />
        </div>
    </form>
</div>
<div class="clearfix"></div>

<script src='/static/js/H5F.js'></script>
<!-- a polyfill that adds HTML5 form validation features to older browsers -->
<script src="http://code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
<script src="/static/Tagit/js/tag-it.js"></script>


<script type="text/javascript">
    // this function is completely unneccesary because of H5F
    // function validateForm() {
    //     // Check if name is filled out
    //     if (!$("input[name='name']:checked").val()) {
    //         $("input[name='name']").addClass("invalid");
    //         /*var nag = document.createElement("div");
    //         nag.css("width", "100%");
    //         nag.css("border", "1px solid black");
    //         $("input[name='name']").parents("div").appendChild(nag);*/
    //         return false;
    //     }
    // 
    //     // Check if they filled out shirt gender & size
    //     !$("input[name='shirt_gen']:checked").val() && return false;
    //     !$("input[name='shirt_size']:checked").val() && return false;
    //     !$("input[name='hardware_hack']:checked").val() && return false;
    //     // Check if they agree to the Code of Conduct
    //     !$("input[name=agree]:checked").val() && return false;
    // 
    //     return true;
    // }

    function createDropDown(){
        var source = $("#source");
        var selected = source.find("option[selected]");  // get selected <option>
        var options = $("option", source);  // get all <option> elements
        // create <dl> and <dt> with selected value inside it
        $(".yr").append('<dl id="target" class="dropdown"></dl>')
        $("#target").append('<dt><a href="#">' + selected.text() + 
            '<span class="value">' + selected.val() + 
            '</span></a></dt>')
        $("#target").append('<dd><ul></ul></dd>')
        // iterate through all the <option> elements and create UL
        options.each(function(){
            $("#target dd ul").append('<li><a href="#">' + 
                $(this).text() + '<span class="value">' + 
                $(this).val() + '</span></a></li>');
        });

        source.hide();
    }

    $(document).ready(function () {
        H5F.setup(document.getElementById("registration_form"), {
            onInvalid: function (e) {
                var nameIn = document.querySelectorAll("input[name='name']");
                nameIn.checkValidity() && nameIn.classList.add(invalid);
                alert("You didn't finish!"); // temp
            },
            // this shouldn't even happen if `e.form.checkValidity()` isn't true
            onSubmit: function (e) {
                e.preventDefault();
                // if (e.form.checkValidity()) { // might just be `this.checkValidity()`
                $("#registration_form input[type=submit]").val("Registering you...").attr({
                    disabled: true
                });
    
                var form_data = {};
                var a = $("#registration_form").serializeArray();
                $.each(a, function() {
                    if (form_data[this.name] !== undefined) {
                        if (!form_data[this.name].push) {
                            form_data[this.name] = [form_data[this.name]];
                        }
                        form_data[this.name].push(this.value || '');
                    } else {
                        form_data[this.name] = this.value || '';
                    }
                });
                var register_url = $("#registration_form").attr('action');
                $.ajax({
                    type: "POST",
                    url: register_url,
                    cache: false,
                    processData: false,
                    data: JSON.stringify(form_data),
                    success: function (response) {
                        var response = JSON.parse(response);
                        if (response.success) {
                            console.log("success!")
                            $("#splash").html(response.replace_splash_with_html);
                            window.location.hash = "";
                        }
                        else{
                            $("#registration_form input[type=submit]").val("Email already Registered!").attr({
                                disabled: true
                            });
                        }
                    }
                })
            }
        });

        // Do some validation color stuff
        function toggleInvalid(el) {
            if (el.val() == "")
                el.addClass("invalid");
            else
                el.removeClass("invalid");
        }

        $("input[name='name']").focusout(function () {
            toggleInvalid($(this));
        })

        $("input[name='school']").focusout(function () {
            toggleInvalid($(this));
        })

        // Get datas
        var $diet_restrictions = [];
        $.getJSON("/static/data/dietary-restrictions.json", function (data) {
            $.each(data, function (key, val) {
                $diet_restrictions[key] = val;
            })
        });

        var $universities = [];
        $.getJSON("/static/data/universities.json", function (data) {
            $.each(data, function (key, val) {
                $universities[key] = val;
            })
        });

        // On email change & valid, check for university domain
        function searchUniversities(domain) {
            $universities.forEach(function (obj) {
                if (domain == obj["domain"]) {
                    $(".registration_form input[name='school']").val(obj["label"]);
                }
            });
        }

        $("input[type='email']").change(function () {
            var splitEmail = $(this).val().split('@');
            if (splitEmail.length == 2) {
                var univ = searchUniversities(splitEmail[1]);
                if (univ != null)
                    $(".registration_form input.schools").val(univ);
            }
        });

        // Setting up tagit for dietary restrictions and teammates
        $(".tagit.diet").tagit({
            allowSpaces: true,
            availableTags: $diet_restrictions
        });

        $(".tagit.team").tagit({
            maxTags: 3
        });

        $("ul.tagit input").focus(function () {
            $(this).parents("ul").css("box-shadow", "inset 1px -50px 0px -1px #404040");
            $(this).parents("ul").children("li.tagit-choice").css("background-color", "#404040");
        });

        $("ul.tagit input").focusout(function () {
            if ($("ul.tagit").children("li").length > 2) {
                $(this).parents("ul").css("box-shadow", "inset 1px -3px 0px -1px #1B8EB9");
            } else {
                $(this).parents("ul").css("box-shadow", "inset 1px -3px 0px -1px rgba(145,143,140,0.3)");
            }         
            $(this).parents("ul").children("li.tagit-choice").css("background-color", "rgb(59,142,185)");
        });


        // Autocomplete suggestions for schools
        $(function () {
            $(".schools").autocomplete({
                source: $universities
            });
        });

        // Condor dynamic link input stuff
        $(".condor").condor({
            uniqueNames: false,
            namePrefix: 'links',
            activeHint: 'Github, Dribbble, Behance, etc.',
            inactiveHint: 'add another link'
        });

        // Custom dropdown
        createDropDown();

        function removeFocus() {
            $(".dropdown dt a").removeClass("focus");
            $(".dropdown dd ul").css("max-height", "0");
        }

        $(".dropdown dt a").click(function(e) {
            e.preventDefault();
            if ($(this).hasClass("focus")) {
                removeFocus();
            } else {
                $(this).addClass("focus");
                $(".dropdown dd ul").css("max-height", "400px");
            }
        });

        $(".dropdown dd ul li a").click(function(e) {
            e.preventDefault();
            var text = $(this).html();
            $(".dropdown dt a").css("box-shadow", "inset 1px -3px 0px -1px #1B8EB9");
            $(".dropdown dt a").css("color", "#121212");
            $(".dropdown dt a").html(text);
            removeFocus();
            var source = $("#source");
            source.val($(this).find("span.value").html());
        });

        $(document).bind('click', function(e) {
            var $clicked = $(e.target);
            if (! $clicked.parents().hasClass("dropdown")) {
                removeFocus();
            }
        });



        

    })

</script>
